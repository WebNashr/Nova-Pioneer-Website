!function(d){window.GPNestedForms=function(e){var s=this;for(prop in e)e.hasOwnProperty(prop)&&(s[prop]=e[prop]);s.init=function(){if(void 0!==window["GPNestedForms_{0}_{1}".format(s.formId,s.fieldId)]){var e=window["GPNestedForms_{0}_{1}".format(s.formId,s.fieldId)];s.entries=e.entries,gform.removeFilter("gform_calculation_formula",10,"gpnf")}s.parentFormContainer=d("#gform_wrapper_"+s.formId),s.fieldContainer=d("#field_"+s.formId+"_"+s.fieldId),s.modalElem=d(".gpnf-nested-form-"+s.formId+"-"+s.fieldId),s.editDialogElem=d(".gpnf-edit-form-"+s.formId+"-"+s.fieldId),s.formHtml=s.getFormHtml(),s.entriesInput=d("#input_"+s.formId+"_"+s.fieldId),s.modalArgs=gform.applyFilters("gpnf_modal_args",{autoOpen:!1,modal:!0,width:s.modalWidth<d(document).width()?s.modalWidth:d(document).width()-40,height:s.modalHeight,title:s.modalTitle,closeText:"Close",buttons:{},position:s.getPosition(),dialogClass:s.modalClass,draggable:!1,resizable:!1,close:function(e,o){s.modalDialog.html(""),s.editDialog.html(""),d(".ui-widget-overlay").removeClass(s.modalClass)},open:function(){s.modalHeaderColor&&(s.modalDialog.siblings(".ui-dialog-titlebar").css("background-color",s.modalHeaderColor),s.editDialog.siblings(".ui-dialog-titlebar").css("background-color",s.modalHeaderColor)),d(".ui-widget-overlay").addClass(s.modalClass),s.hasConditionalLogic?d(document).on("gform_post_conditional_logic",function(e,o){s.nestedFormId==o&&s.repositionModals()}):s.repositionModals()}},s.formId,s.fieldId,s),s.modalDialog=s.modalElem.dialog(s.modalArgs),s.editDialog=s.editDialogElem.dialog(d.extend({},s.modalArgs,{title:s.editModalTitle})),s.entries.length<=0&&window.gpnfNestedEntries[s.formId]&&(s.entries=window.gpnfNestedEntries[s.formId][s.fieldId]),s.isBound(s.fieldContainer[0])||(s.viewModel=new o(s.prepareEntriesForKnockout(s.entries),s),ko.applyBindings(s.viewModel,s.fieldContainer[0])),d(document).on("click","#field_"+s.formId+"_"+s.fieldId+" .gpnf-add-entry",function(e){e.preventDefault(),s.modalElem.html(s.formHtml),s.modalDialog.dialog("open"),s.initFormScripts(),s.modalElem.find('input[name="gpnf_nested_form_field_id"]').val(s.fieldId)}),d(document).bind("gpnf_post_render",function(e,o,n){var t=d("#gform_wrapper_"+o);o==s.nestedFormId&&0<t.length&&d(document).trigger("gform_post_render",[s.nestedFormId,n]),s.repositionModals()}),d(window).resize(function(){s.repositionModals()}),gform.addFilter("gform_calculation_formula",s.parseCalcs,10,"gpnf"),s.runCalc(s.formId),s.parentFormContainer.data("GPNestedForms_"+s.fieldId,s),window["GPNestedForms_{0}_{1}".format(s.formId,s.fieldId)]=s},s.repositionModals=function(){var e=s.getPosition(s.modalDialog);e.dnr||s.modalDialog.dialog("option","position",e),(e=s.getPosition(s.editDialog)).dnr||s.editDialog.dialog("option","position",e)},s.getPosition=function(e){if(!e)return{my:"center",at:"center",of:window};var o=d(window).height(),n=e.parents(".ui-dialog").height(),t="center",i=window,r=!1;return o<=n?(t="center top",i=window,e.data("do-not-reposition")?r=!0:e.data("do-not-reposition",!0)):e.data("do-not-reposition",!1),{my:t,at:t,of:i,dnr:r}},s.isBound=function(e){return!!ko.dataFor(e)},s.prepareEntriesForKnockout=function(e){for(var o=0;o<e.length;o++)e[o]=s.prepareEntryForKnockout(e[o]);return e},s.prepareEntryForKnockout=function(e){var o=d.extend({},e);for(var n in o)if(e.hasOwnProperty(n)){var t=e[n];!1===t.label&&(t.label=""),e["f"+n]=t}return e},s.refreshMarkup=function(){d.post(s.ajaxUrl,{action:"gpnf_refresh_markup",nonce:GPNFData.nonces.refreshMarkup,gpnf_parent_form_id:s.formId,gpnf_nested_form_field_id:s.fieldId},function(e){s.formHtml=e})},s.editEntry=function(e,o){var n=new i(o,!1,"");o.css({visibility:"hidden"}),d.post(s.ajaxUrl,{action:"gpnf_edit_entry",nonce:GPNFData.nonces.editEntry,gpnf_entry_id:e,gpnf_parent_form_id:s.formId,gpnf_nested_form_field_id:s.fieldId},function(e){n.destroy(),o.css({visibility:"visible"}),s.editDialog.html(e).dialog("open"),s.initFormScripts()})},s.deleteEntry=function(o,n){var t=new i(n,!1,"");n.css({visibility:"hidden"}),d.post(s.ajaxUrl,{action:"gpnf_delete_entry",nonce:GPNFData.nonces.deleteEntry,gpnf_entry_id:o.id},function(e){t.destroy(),n.css({visibility:"visible"}),e?e.success?(s.viewModel.entries.remove(o),s.refreshMarkup()):console.log("Error:"+e.data):console.log("Error: no response.")})},s.getFormHtml=function(){var e=s.modalElem.data("formHtml");return e||(e=s.modalElem.html()),s.modalElem.data("formHtml",e),s.modalElem.html(""),e},s.initFormScripts=function(e){d(document).trigger("gform_post_render",[s.nestedFormId,1]),window.gformInitDatepicker&&gformInitDatepicker(),s.modalElem.find(":input").each(function(){var e=d(this).data("gpnf-value");if(!e)return!0;var o=/{Parent:(\d+(\.\d+)?)}/g.exec(e);if(!o)return!0;var n=o[1];if(isNaN(n))return!0;var t=s.parentFormContainer.find("#input_"+s.formId+"_"+n.split(".").join("_")),i=d(this).val(),r=t.val();i!=r&&d(this).val(r).change()})},s.runCalc=function(){d(document).trigger("gform_post_conditional_logic",[s.formId,[],!1])},s.parseCalcs=function(l,e,o,n){var t=getMatchGroups(l,/{[^{]*?:([0-9]+):(sum|total|count)=?([0-9]*)}/i);return d.each(t,function(e,o){var n=o[0],t=o[1],i=o[2],r=o[3],d=0;if(t==s.fieldId){switch(i){case"sum":var a=0;s.viewModel.entries().forEach(function(e){var o=0;void 0!==e[r]&&(o=e[r].value?e[r].value:0),a+=parseFloat(o)}),d=a;break;case"total":a=0;s.viewModel.entries().forEach(function(e){a+=parseFloat(e.total)}),d=a;break;case"count":d=s.viewModel.entries().length}l=l.replace(n,d)}}),l},GPNestedForms.loadEntry=function(e){var o=d("#gform_wrapper_"+e.formId).data("GPNestedForms_"+e.fieldId);if(entry=o.prepareEntryForKnockout(e.fieldValues),entry.id=e.entryId,"edit"==e.mode){var n=d('table.gpnf-nested-entries [data-entryid="'+entry.id+'"]').index();o.viewModel.entries.remove(function(e){return e.id==entry.id}),o.viewModel.entries.splice(n,0,entry),o.editDialog.dialog("close")}else o.modalDialog.dialog("close"),o.viewModel.entries.push(entry),s.refreshMarkup()},s.init()};var o=function(e,n){var o=this;o.entries=ko.observableArray(e),o.isMaxed=ko.computed(function(){return""!==n.entryLimitMax&&o.entries().length>=n.entryLimitMax}),o.entryIds=ko.computed(function(){var n=[];return d.each(o.entries(),function(e,o){n.push(o.id)}),n},o),o.runCalc=ko.computed(function(){return n.runCalc(),o.entries().length},o),o.editEntry=function(e,o){n.editEntry(e.id,d(o.target))},o.deleteEntry=function(e,o){n.deleteEntry(e,d(o.target))}};function i(e,o,n){return o=void 0!==o&&o?o:gf_global.base_url+"/images/spinner.gif",n=void 0!==n?n:"",this.elem=e,this.image='<img class="gfspinner" src="'+o+'" style="'+n+'" />',this.init=function(){return this.spinner=jQuery(this.image),jQuery(this.elem).after(this.spinner),this},this.destroy=function(){jQuery(this.spinner).remove()},this.init()}window.gpnfEventHandler=function(e,n,t){if(void 0===window.gpnfEvents&&(window.gpnfEvents=[]),0==window.gpnfEvents.length){var o=d._data(document).events.gform_post_render;d.each(o,function(e,o){"gpnf"==o.namespace&&window.gpnfEvents.push(o.handler)}),d(document).off("gform_post_render.gpnf")}d.each(window.gpnfEvents,function(e,o){o(o,n,t)})}}(jQuery);
//# sourceMappingURL=gp-nested-forms.js.map